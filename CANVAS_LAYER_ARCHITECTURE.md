# Canvas v4.0 ë‹¤ì¤‘ ì´ë¯¸ì§€ í¸ì§‘ & ë ˆì´ì–´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ì„¤ê³„ì„œ

## ğŸ“‹ ê°œìš”

Canvas v4.0 ì‹œìŠ¤í…œì— ì™„ì „í•œ ë‹¤ì¤‘ ì´ë¯¸ì§€ í¸ì§‘ ë° ë ˆì´ì–´ ì‹œìŠ¤í…œì„ ë„ì…í•˜ëŠ” ì¢…í•© ì•„í‚¤í…ì²˜ì…ë‹ˆë‹¤. ê¸°ì¡´ Canvas v4.0ì˜ ì•ˆì •ì„±ì„ ìœ ì§€í•˜ë©´ì„œ Adobe Photoshop/Figma ìˆ˜ì¤€ì˜ ê³ ê¸‰ í¸ì§‘ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.

### ğŸ¯ í•µì‹¬ ëª©í‘œ

- **ì™„ì „í•œ í˜¸í™˜ì„±**: ê¸°ì¡´ Canvas v4.0 ì‹œìŠ¤í…œê³¼ 100% í˜¸í™˜
- **ì „ë¬¸ê°€ê¸‰ ê¸°ëŠ¥**: Adobe Photoshop ìˆ˜ì¤€ì˜ ë ˆì´ì–´ í¸ì§‘ ì‹œìŠ¤í…œ
- **ì‹¤ì‹œê°„ ì„±ëŠ¥**: WebGL ê¸°ë°˜ 60fps ì‹¤ì‹œê°„ ë Œë”ë§
- **í™•ì¥ ê°€ëŠ¥ì„±**: í”ŒëŸ¬ê·¸ì¸ ì•„í‚¤í…ì²˜ë¡œ ë¬´í•œ í™•ì¥
- **ì—”í„°í”„ë¼ì´ì¦ˆ ì•ˆì •ì„±**: ëŒ€ìš©ëŸ‰ ë°ì´í„° ë° ë™ì‹œ í¸ì§‘ ì§€ì›

## ğŸ—ï¸ ì „ì²´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### ì‹œìŠ¤í…œ ê³„ì¸µ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ ê³„ì¸µ                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Canvas v4.0 UI    â”‚  Layer Panel  â”‚  Tools Panel  â”‚ Props â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê³„ì¸µ                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer Store  â”‚  Canvas Store  â”‚  Image Session Store      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    ë Œë”ë§ ì—”ì§„ ê³„ì¸µ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  WebGL Renderer  â”‚  Canvas 2D Fallback  â”‚  Cache Manager  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    ë°ì´í„° ì•¡ì„¸ìŠ¤ ê³„ì¸µ                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PostgreSQL  â”‚  File Storage  â”‚  Cache Layer  â”‚  Real-time â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### í•µì‹¬ ì»´í¬ë„ŒíŠ¸ ê´€ê³„ë„

```mermaid
graph TB
    A[Canvas v4.0 Workspace] --> B[Layer Container]
    B --> C[Layer Store]
    B --> D[WebGL Renderer]
    
    C --> E[Layer Cache]
    C --> F[Edit History]
    C --> G[Event System]
    
    D --> H[Shader Programs]
    D --> I[Texture Manager]
    D --> J[Render Batching]
    
    K[Canvas v4.0 Adapter] --> B
    K --> L[Image Generator]
    K --> M[Version Gallery]
    
    N[PostgreSQL] --> O[Layer Models]
    N --> P[Asset Models]
    N --> Q[Cache Models]
```

## ğŸ“ íŒŒì¼ êµ¬ì¡°

```
frontend/src/
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ layer.ts                    # ë ˆì´ì–´ ì‹œìŠ¤í…œ íƒ€ì… ì •ì˜
â”‚   â””â”€â”€ canvas.ts                   # ê¸°ì¡´ Canvas v4.0 íƒ€ì… (í™•ì¥)
â”œâ”€â”€ stores/
â”‚   â”œâ”€â”€ layerStore.ts              # ë ˆì´ì–´ ìƒíƒœ ê´€ë¦¬ (Zustand)
â”‚   â”œâ”€â”€ canvasStore.ts             # ê¸°ì¡´ Canvas v4.0 ìŠ¤í† ì–´
â”‚   â””â”€â”€ imageSessionStore.ts       # ê¸°ì¡´ ì´ë¯¸ì§€ ì„¸ì…˜ ìŠ¤í† ì–´
â”œâ”€â”€ engines/
â”‚   â”œâ”€â”€ WebGLRenderer.ts           # WebGL ë Œë”ë§ ì—”ì§„
â”‚   â”œâ”€â”€ Canvas2DRenderer.ts        # Canvas 2D í´ë°± ë Œë”ëŸ¬
â”‚   â””â”€â”€ LayerCompositor.ts         # ë ˆì´ì–´ í•©ì„± ì—”ì§„
â”œâ”€â”€ adapters/
â”‚   â””â”€â”€ CanvasV4LayerAdapter.ts    # Canvas v4.0 í˜¸í™˜ì„± ì–´ëŒ‘í„°
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ layer/
â”‚   â”‚   â”œâ”€â”€ LayerPanel.tsx         # ë ˆì´ì–´ íŒ¨ë„ UI
â”‚   â”‚   â”œâ”€â”€ LayerItem.tsx          # ê°œë³„ ë ˆì´ì–´ ì•„ì´í…œ
â”‚   â”‚   â”œâ”€â”€ LayerToolbar.tsx       # ë ˆì´ì–´ ë„êµ¬ ëª¨ìŒ
â”‚   â”‚   â””â”€â”€ LayerProperties.tsx    # ë ˆì´ì–´ ì†ì„± íŒ¨ë„
â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â”œâ”€â”€ SelectionTool.tsx      # ì„ íƒ ë„êµ¬
â”‚   â”‚   â”œâ”€â”€ TransformTool.tsx      # ë³€í˜• ë„êµ¬
â”‚   â”‚   â”œâ”€â”€ BrushTool.tsx          # ë¸ŒëŸ¬ì‹œ ë„êµ¬
â”‚   â”‚   â””â”€â”€ MaskingTool.tsx        # ë§ˆìŠ¤í‚¹ ë„êµ¬
â”‚   â””â”€â”€ canvas/
â”‚       â”œâ”€â”€ CanvasWorkspace.tsx    # ê¸°ì¡´ Canvas ì›Œí¬ìŠ¤í˜ì´ìŠ¤ (í™•ì¥)
â”‚       â”œâ”€â”€ LayerCanvas.tsx        # ë ˆì´ì–´ ì „ìš© ìº”ë²„ìŠ¤
â”‚       â””â”€â”€ ImageGenerator.tsx     # ê¸°ì¡´ ì´ë¯¸ì§€ ìƒì„±ê¸° (í†µí•©)
â””â”€â”€ services/
    â”œâ”€â”€ LayerService.ts            # ë ˆì´ì–´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
    â”œâ”€â”€ RenderService.ts           # ë Œë”ë§ ì„œë¹„ìŠ¤
    â””â”€â”€ CacheService.ts            # ìºì‹œ ê´€ë¦¬ ì„œë¹„ìŠ¤

backend/app/
â”œâ”€â”€ db/models/
â”‚   â”œâ”€â”€ layer.py                   # ë ˆì´ì–´ ë°ì´í„° ëª¨ë¸
â”‚   â””â”€â”€ canvas.py                  # ê¸°ì¡´ Canvas ëª¨ë¸ (í™•ì¥)
â”œâ”€â”€ api/v1/
â”‚   â”œâ”€â”€ layers.py                  # ë ˆì´ì–´ API ì—”ë“œí¬ì¸íŠ¸
â”‚   â””â”€â”€ canvas.py                  # ê¸°ì¡´ Canvas API (í™•ì¥)
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ layer_service.py           # ë ˆì´ì–´ ì„œë¹„ìŠ¤
â”‚   â”œâ”€â”€ render_service.py          # ë Œë”ë§ ì„œë¹„ìŠ¤
â”‚   â””â”€â”€ cache_service.py           # ìºì‹œ ì„œë¹„ìŠ¤
â””â”€â”€ agents/workers/
    â””â”€â”€ layer_processor.py         # ë ˆì´ì–´ ì²˜ë¦¬ ì—ì´ì „íŠ¸
```

## ğŸ”§ 1. ë ˆì´ì–´ ì‹œìŠ¤í…œ ì„¤ê³„

### 1.1 ë ˆì´ì–´ íƒ€ì… ê³„ì¸µ

```typescript
enum LayerType {
  BACKGROUND = 'background',    // ë°°ê²½ ë ˆì´ì–´
  IMAGE = 'image',             // ì´ë¯¸ì§€ ë ˆì´ì–´
  TEXT = 'text',               // í…ìŠ¤íŠ¸ ë ˆì´ì–´
  SHAPE = 'shape',             // ë„í˜• ë ˆì´ì–´
  EFFECT = 'effect',           // íš¨ê³¼ ë ˆì´ì–´
  MASK = 'mask',               // ë§ˆìŠ¤í¬ ë ˆì´ì–´
  GROUP = 'group'              // ê·¸ë£¹ ë ˆì´ì–´
}
```

### 1.2 ë ˆì´ì–´ ìƒíƒœ ê´€ë¦¬

**í•µì‹¬ ì¸í„°í˜ì´ìŠ¤:**
- `LayerContainer`: ë ˆì´ì–´ë“¤ì˜ ì»¨í…Œì´ë„ˆ (Canvas v4.0ì™€ 1:1 ë§¤í•‘)
- `Layer`: ê°œë³„ ë ˆì´ì–´ (ImageLayer, TextLayer, GroupLayer ë“±)
- `LayerTransform`: ë³€í˜• ì •ë³´ (ìœ„ì¹˜, í¬ê¸°, íšŒì „, ê¸°ìš¸ê¸°)
- `LayerState`: ê°€ì‹œì„±, ì ê¸ˆ, ë¶ˆíˆ¬ëª…ë„, ë¸”ë Œë“œ ëª¨ë“œ

**íŠ¹ì§•:**
- **ê³„ì¸µ êµ¬ì¡°**: ë¶€ëª¨-ìì‹ ê´€ê³„ë¡œ ê·¸ë£¹ ê´€ë¦¬
- **Z-Index ê´€ë¦¬**: ë Œë”ë§ ìˆœì„œ ì œì–´
- **ë‹¤ì¤‘ ì„ íƒ**: ì—¬ëŸ¬ ë ˆì´ì–´ ë™ì‹œ í¸ì§‘
- **ì‹¤ì‹œê°„ ë™ê¸°í™”**: ë³€ê²½ì‚¬í•­ ì¦‰ì‹œ ë°˜ì˜

### 1.3 ë³€í˜• ì‹œìŠ¤í…œ

```typescript
interface LayerTransform {
  x: number;          // X ì¢Œí‘œ
  y: number;          // Y ì¢Œí‘œ
  scaleX: number;     // Xì¶• í¬ê¸°
  scaleY: number;     // Yì¶• í¬ê¸°
  rotation: number;   // íšŒì „ (ë„)
  skewX: number;      // Xì¶• ê¸°ìš¸ê¸°
  skewY: number;      // Yì¶• ê¸°ìš¸ê¸°
  offsetX: number;    // X ì˜¤í”„ì…‹
  offsetY: number;    // Y ì˜¤í”„ì…‹
}
```

**ê³ ê¸‰ ê¸°ëŠ¥:**
- **ë¹„íŒŒê´´ ë³€í˜•**: ì›ë³¸ ë°ì´í„° ë³´ì¡´
- **ë³€í˜• í–‰ë ¬**: GPU ê°€ì† ë³€í˜• ê³„ì‚°
- **ì œì•½ ì¡°ê±´**: ë¹„ìœ¨ ê³ ì •, ê·¸ë¦¬ë“œ ìŠ¤ëƒ…
- **í‚¤í”„ë ˆì„**: ì• ë‹ˆë©”ì´ì…˜ ì§€ì› (ë¯¸ë˜)

### 1.4 ë¸”ë Œë“œ ëª¨ë“œ

```typescript
enum BlendMode {
  NORMAL = 'normal',
  MULTIPLY = 'multiply',
  SCREEN = 'screen',
  OVERLAY = 'overlay',
  SOFT_LIGHT = 'soft_light',
  HARD_LIGHT = 'hard_light',
  COLOR_DODGE = 'color_dodge',
  COLOR_BURN = 'color_burn',
  DARKEN = 'darken',
  LIGHTEN = 'lighten',
  DIFFERENCE = 'difference',
  EXCLUSION = 'exclusion'
}
```

## ğŸ¨ 2. ë‹¤ì¤‘ ì´ë¯¸ì§€ ì²˜ë¦¬ ì‹œìŠ¤í…œ

### 2.1 ì´ë¯¸ì§€ ë ˆì´ì–´ êµ¬ì¡°

```typescript
interface ImageLayer extends BaseLayer {
  content: {
    imageUrl: string;           // ë©”ì¸ ì´ë¯¸ì§€ URL
    originalUrl?: string;       // ì›ë³¸ URL
    thumbnailUrl?: string;      // ì¸ë„¤ì¼ URL
    naturalWidth: number;       // ì›ë³¸ ê°€ë¡œ í¬ê¸°
    naturalHeight: number;      // ì›ë³¸ ì„¸ë¡œ í¬ê¸°
    format: 'jpeg' | 'png' | 'webp' | 'svg';
    
    // AI ìƒì„± ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„°
    aiGenerated?: {
      prompt: string;
      model: string;
      style: string;
      seed?: number;
      generatedAt: string;
    };
  };
}
```

### 2.2 ë‹¤ì¤‘ ì´ë¯¸ì§€ ê´€ë¦¬

**íŠ¹ì§•:**
- **ë…ë¦½ì  ë ˆì´ì–´**: ê° ì´ë¯¸ì§€ê°€ ë…ë¦½ ë ˆì´ì–´
- **ìë™ ë°°ì¹˜**: ìŠ¤ë§ˆíŠ¸ ìœ„ì¹˜ ì¡°ì • ì•Œê³ ë¦¬ì¦˜
- **ì¼ê´„ ì‘ì—…**: ë‹¤ì¤‘ ì´ë¯¸ì§€ ë™ì‹œ í¸ì§‘
- **ë²„ì „ ê´€ë¦¬**: ì´ë¯¸ì§€ë³„ í¸ì§‘ íˆìŠ¤í† ë¦¬

**ë°°ì¹˜ ì•Œê³ ë¦¬ì¦˜:**
```typescript
// ìë™ ë°°ì¹˜ ì˜ˆì‹œ
const autoArrangeImages = (images: ImageLayer[]): void => {
  const cols = Math.ceil(Math.sqrt(images.length));
  const spacing = 20;
  const maxWidth = 200;
  
  images.forEach((layer, index) => {
    const row = Math.floor(index / cols);
    const col = index % cols;
    
    layer.transform.x = col * (maxWidth + spacing);
    layer.transform.y = row * (maxWidth + spacing);
  });
};
```

### 2.3 ì´ë¯¸ì§€ ìµœì í™”

**ì„±ëŠ¥ ìµœì í™”:**
- **ë ˆì´ì§€ ë¡œë”©**: ë·°í¬íŠ¸ ë‚´ ì´ë¯¸ì§€ë§Œ ë¡œë“œ
- **ë‹¤í•´ìƒë„ ì§€ì›**: í™•ëŒ€/ì¶•ì†Œì— ë”°ë¥¸ ì ì‘í˜• í•´ìƒë„
- **í¬ë§· ìµœì í™”**: WebP ìš°ì„ , í´ë°± ì§€ì›
- **ì••ì¶• ê´€ë¦¬**: í’ˆì§ˆ/ìš©ëŸ‰ ê· í˜•

## ğŸ› ï¸ 3. í¸ì§‘ ë„êµ¬ ì‹œìŠ¤í…œ

### 3.1 ì„ íƒ ë„êµ¬

```typescript
enum SelectionTool {
  RECTANGLE = 'rectangle',     // ì‚¬ê°í˜• ì„ íƒ
  LASSO = 'lasso',            // ì˜¬ê°€ë¯¸ ì„ íƒ
  MAGIC_WAND = 'magic_wand',  // ë§ˆë²•ë´‰ ì„ íƒ
  COLOR_RANGE = 'color_range' // ìƒ‰ìƒ ë²”ìœ„ ì„ íƒ
}
```

**ê³ ê¸‰ ì„ íƒ ê¸°ëŠ¥:**
- **í˜ë”ë§**: ê²½ê³„ ë¶€ë“œëŸ½ê²Œ ì²˜ë¦¬
- **ì•ˆí‹°ì•¨ë¦¬ì–´ì‹±**: ê³„ë‹¨ í˜„ìƒ ì œê±°
- **ë³µí•© ì„ íƒ**: ì¶”ê°€/ë¹¼ê¸°/êµì§‘í•© ì—°ì‚°
- **ì„ íƒ ì €ì¥**: ì„ íƒ ì˜ì—­ ì¬ì‚¬ìš©

### 3.2 ë³€í˜• ë„êµ¬

**ë³€í˜• ëª¨ë“œ:**
- **ììœ  ë³€í˜•**: ëª¨ë“  ë³€í˜• ì ìš©
- **ê· ë“± ë¹„ìœ¨**: ë¹„ìœ¨ ìœ ì§€ í¬ê¸° ì¡°ì •
- **ì›ê·¼ ë³€í˜•**: 3D ì›ê·¼ íš¨ê³¼
- **ì™œê³¡**: ììœ ê³¡ì„  ë³€í˜•

**ìŠ¤ë§ˆíŠ¸ ê°€ì´ë“œ:**
```typescript
interface SmartGuide {
  type: 'center' | 'edge' | 'grid';
  position: { x: number; y: number };
  magnetic: boolean;  // ìì„ íš¨ê³¼
  visible: boolean;
}
```

### 3.3 ë§ˆìŠ¤í‚¹ ì‹œìŠ¤í…œ

```typescript
interface LayerMask {
  type: 'alpha' | 'clipping' | 'vector';
  data: string | Path2D;     // ë§ˆìŠ¤í¬ ë°ì´í„°
  inverted: boolean;         // ë§ˆìŠ¤í¬ ë°˜ì „
  feather: number;           // ê²½ê³„ íë¦¬ê¸°
}
```

**ë§ˆìŠ¤í‚¹ ê¸°ëŠ¥:**
- **ì•ŒíŒŒ ë§ˆìŠ¤í¬**: íˆ¬ëª…ë„ ê¸°ë°˜ ë§ˆìŠ¤í‚¹
- **í´ë¦¬í•‘ ë§ˆìŠ¤í¬**: ìƒìœ„ ë ˆì´ì–´ë¡œ ë§ˆìŠ¤í‚¹
- **ë²¡í„° ë§ˆìŠ¤í¬**: íŒ¨ìŠ¤ ê¸°ë°˜ ë§ˆìŠ¤í‚¹
- **ë§ˆìŠ¤í¬ í¸ì§‘**: ì‹¤ì‹œê°„ ë§ˆìŠ¤í¬ ìˆ˜ì •

## ğŸ—„ï¸ 4. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### 4.1 í•µì‹¬ í…Œì´ë¸”

**LayerContainer** (ë ˆì´ì–´ ì»¨í…Œì´ë„ˆ)
```sql
CREATE TABLE layer_containers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    canvas_id UUID NOT NULL REFERENCES canvases(id),
    conversation_id UUID REFERENCES conversations(id),
    
    name VARCHAR(255) NOT NULL,
    canvas_config JSONB NOT NULL DEFAULT '{"width": 1920, "height": 1080}',
    viewport_config JSONB NOT NULL DEFAULT '{"zoom": 1.0}',
    render_settings JSONB NOT NULL,
    
    layer_order UUID[] DEFAULT ARRAY[]::UUID[],
    selected_layer_ids UUID[] DEFAULT ARRAY[]::UUID[],
    version INTEGER DEFAULT 1,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**CanvasLayer** (ê°œë³„ ë ˆì´ì–´)
```sql
CREATE TABLE canvas_layers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    container_id UUID NOT NULL REFERENCES layer_containers(id),
    
    name VARCHAR(255) NOT NULL,
    layer_type VARCHAR(20) NOT NULL,
    parent_id UUID REFERENCES canvas_layers(id),
    z_index INTEGER DEFAULT 0,
    
    transform_data JSONB NOT NULL DEFAULT '{}',
    bounding_box JSONB NOT NULL DEFAULT '{}',
    state_data JSONB NOT NULL DEFAULT '{}',
    content_data JSONB NOT NULL DEFAULT '{}',
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**LayerCache** (ì„±ëŠ¥ ìºì‹œ)
```sql
CREATE TABLE layer_caches (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    layer_id UUID NOT NULL REFERENCES canvas_layers(id),
    
    cache_key VARCHAR(64) UNIQUE NOT NULL,
    cache_type VARCHAR(20) NOT NULL,
    storage_path VARCHAR(500),
    size_bytes INTEGER DEFAULT 0,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    last_accessed TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ
);
```

### 4.2 ì¸ë±ì‹± ì „ëµ

```sql
-- ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤
CREATE INDEX idx_layer_containers_canvas_id ON layer_containers(canvas_id);
CREATE INDEX idx_canvas_layers_container_id ON canvas_layers(container_id);
CREATE INDEX idx_canvas_layers_z_index ON canvas_layers(z_index);
CREATE INDEX idx_layer_caches_cache_key ON layer_caches(cache_key);
CREATE INDEX idx_layer_caches_expires_at ON layer_caches(expires_at);
```

## ğŸš€ 5. WebGL ë Œë”ë§ ì—”ì§„

### 5.1 ë Œë”ë§ íŒŒì´í”„ë¼ì¸

```
[Input Layers] â†’ [Culling] â†’ [Batching] â†’ [Shader Pipeline] â†’ [Output Canvas]
     â†“              â†“           â†“             â†“               â†“
   ë ˆì´ì–´ ì •ë ¬    ë·°í¬íŠ¸ ì»¬ë§   ë Œë” ë°°ì¹­    GPU ì²˜ë¦¬        ìµœì¢… ì¶œë ¥
```

### 5.2 ì…°ì´ë” ì‹œìŠ¤í…œ

**ê¸°ë³¸ ë²„í…ìŠ¤ ì…°ì´ë”:**
```glsl
precision mediump float;

attribute vec2 a_position;
attribute vec2 a_texCoord;

uniform mat3 u_transform;
uniform vec2 u_resolution;

varying vec2 v_texCoord;

void main() {
  vec3 position = u_transform * vec3(a_position, 1.0);
  vec2 clipspace = ((position.xy / u_resolution) * 2.0) - 1.0;
  gl_Position = vec4(clipspace * vec2(1, -1), 0, 1);
  v_texCoord = a_texCoord;
}
```

**ë¸”ë Œë”© í”„ë˜ê·¸ë¨¼íŠ¸ ì…°ì´ë”:**
```glsl
precision mediump float;

uniform sampler2D u_texture;
uniform sampler2D u_background;
uniform float u_opacity;
uniform int u_blendMode;

vec3 blendMultiply(vec3 base, vec3 blend) {
  return base * blend;
}

vec3 applyBlendMode(vec3 base, vec3 blend, int mode) {
  if (mode == 1) return blendMultiply(base, blend);
  // ... ë‹¤ë¥¸ ë¸”ë Œë“œ ëª¨ë“œë“¤
  return blend;
}

void main() {
  vec4 sourceColor = texture2D(u_texture, v_texCoord);
  vec4 backgroundColor = texture2D(u_background, v_texCoord);
  
  vec3 blended = applyBlendMode(backgroundColor.rgb, sourceColor.rgb, u_blendMode);
  float alpha = sourceColor.a * u_opacity;
  
  gl_FragColor = vec4(mix(backgroundColor.rgb, blended, alpha), 
                      backgroundColor.a + alpha * (1.0 - backgroundColor.a));
}
```

### 5.3 ë Œë”ë§ ìµœì í™”

**ë°°ì¹˜ ìµœì í™”:**
- **ìƒíƒœ ë³€ê²½ ìµœì†Œí™”**: ë™ì¼ ì…°ì´ë”/í…ìŠ¤ì²˜ ê·¸ë£¹í™”
- **í…ìŠ¤ì²˜ ì•„í‹€ë¼ìŠ¤**: ì‘ì€ ì´ë¯¸ì§€ë“¤ í†µí•©
- **ì¸ìŠ¤í„´ìŠ¤ ë Œë”ë§**: ë™ì¼ í˜•íƒœ ê°ì²´ ì¼ê´„ ì²˜ë¦¬
- **GPU ë²„í¼ë§**: ë”ë¸” ë²„í¼ë§ìœ¼ë¡œ ëŠê¹€ ì—†ëŠ” ë Œë”ë§

**ë©”ëª¨ë¦¬ ê´€ë¦¬:**
```typescript
class TextureManager {
  private texturePool: Map<string, WebGLTexture> = new Map();
  private lruCache: LRUCache<string, WebGLTexture>;
  
  getTexture(url: string): WebGLTexture {
    // LRU ìºì‹œ ê¸°ë°˜ í…ìŠ¤ì²˜ ê´€ë¦¬
    if (this.lruCache.has(url)) {
      return this.lruCache.get(url)!;
    }
    
    const texture = this.loadTexture(url);
    this.lruCache.set(url, texture);
    return texture;
  }
  
  cleanup(): void {
    // ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” í…ìŠ¤ì²˜ ì •ë¦¬
    this.lruCache.clear();
  }
}
```

## ğŸ”„ 6. Canvas v4.0 í˜¸í™˜ì„±

### 6.1 í†µí•© ì–´ëŒ‘í„°

**CanvasV4LayerAdapter**ëŠ” ê¸°ì¡´ ì‹œìŠ¤í…œê³¼ ìƒˆ ë ˆì´ì–´ ì‹œìŠ¤í…œ ê°„ì˜ ì™„ì „í•œ ë¸Œë¦¬ì§€ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

**ì£¼ìš” ê¸°ëŠ¥:**
- **ì–‘ë°©í–¥ ë³€í™˜**: Canvas Item â†” Layer ì™„ì „ ë³€í™˜
- **ì‹¤ì‹œê°„ ë™ê¸°í™”**: ë³€ê²½ì‚¬í•­ ì¦‰ì‹œ ë°˜ì˜
- **íƒ€ì… ë§¤í•‘**: ì™„ì „í•œ íƒ€ì… í˜¸í™˜ì„±
- **ë©”íƒ€ë°ì´í„° ë³´ì¡´**: ê¸°ì¡´ ë°ì´í„° ì†ì‹¤ ì—†ìŒ

### 6.2 í˜¸í™˜ì„± ë§¤íŠ¸ë¦­ìŠ¤

| Canvas v4.0 ê¸°ëŠ¥ | ë ˆì´ì–´ ì‹œìŠ¤í…œ ëŒ€ì‘ | í˜¸í™˜ì„± |
|-----------------|----------------|--------|
| í…ìŠ¤íŠ¸ ë…¸íŠ¸ | TextLayer | âœ… ì™„ì „ |
| ì´ë¯¸ì§€ ìƒì„± | ImageLayer | âœ… ì™„ì „ |
| ë§ˆì¸ë“œë§µ | ë‹¤ì¤‘ TextLayer | âœ… ì™„ì „ |
| ìœ„ì¹˜/í¬ê¸° | Transform | âœ… ì™„ì „ |
| ë©”íƒ€ë°ì´í„° | Metadata | âœ… ì™„ì „ |

### 6.3 ê¸°ì¡´ ì‹œìŠ¤í…œ í†µí•©

**ImageGenerator í†µí•©:**
```typescript
integrateWithImageGenerator(layerContainer: LayerContainer): void {
  const imageLayerIds = Object.values(layerContainer.layers)
    .filter(layer => layer.type === LayerType.IMAGE)
    .map(layer => layer.id);

  if (imageLayerIds.length > 0 && layerContainer.conversationId) {
    this.imageSessionStore.createSessionHybrid(
      layerContainer.conversationId,
      layerContainer.id,
      'layer-integration'
    );
  }
}
```

## ğŸ“Š 7. ì„±ëŠ¥ ìµœì í™” ì „ëµ

### 7.1 ìºì‹± ì‹œìŠ¤í…œ

**3-Tier ìºì‹±:**
1. **L1 - ë©”ëª¨ë¦¬ ìºì‹œ**: í™œì„± ë ˆì´ì–´ ë°ì´í„°
2. **L2 - ë¡œì»¬ ìŠ¤í† ë¦¬ì§€**: ë Œë”ë§ëœ ì´ë¯¸ì§€ ìºì‹œ
3. **L3 - ì„œë²„ ìºì‹œ**: ì²˜ë¦¬ëœ ì—ì…‹ ìºì‹œ

### 7.2 ë Œë”ë§ ìµœì í™”

**ì ì‘í˜• í’ˆì§ˆ ì¡°ì •:**
```typescript
class AdaptiveQualityManager {
  adjustQuality(renderTime: number): RenderQuality {
    if (renderTime > 33) return 'draft';      // 30fps ë¯¸ë§Œ
    if (renderTime > 16) return 'normal';     // 60fps ë¯¸ë§Œ  
    return 'high';                            // 60fps ì´ìƒ
  }
}
```

**ë·°í¬íŠ¸ ì»¬ë§:**
```typescript
const getVisibleLayers = (
  layers: Layer[], 
  viewport: BoundingBox
): Layer[] => {
  return layers.filter(layer => 
    isIntersecting(layer.boundingBox, viewport)
  );
};
```

### 7.3 ë©”ëª¨ë¦¬ ê´€ë¦¬

**ìŠ¤ë§ˆíŠ¸ GC:**
- **ì°¸ì¡° ì¹´ìš´íŒ…**: ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” í…ìŠ¤ì²˜ ìë™ í•´ì œ
- **ë©”ëª¨ë¦¬ ì••ë°• ëŒ€ì‘**: ë©”ëª¨ë¦¬ ë¶€ì¡± ì‹œ ìë™ ìºì‹œ ì •ë¦¬
- **ë°±ê·¸ë¼ìš´ë“œ ìµœì í™”**: ìœ íœ´ ì‹œê°„ í™œìš© ë©”ëª¨ë¦¬ ì •ë¦¬

## ğŸ”’ 8. ë³´ì•ˆ ë° ê¶Œí•œ ê´€ë¦¬

### 8.1 ë ˆì´ì–´ ê¶Œí•œ ì‹œìŠ¤í…œ

```typescript
enum LayerPermission {
  VIEW = 'view',      // ë³´ê¸° ê¶Œí•œ
  EDIT = 'edit',      // í¸ì§‘ ê¶Œí•œ
  DELETE = 'delete',  // ì‚­ì œ ê¶Œí•œ
  SHARE = 'share'     // ê³µìœ  ê¶Œí•œ
}
```

### 8.2 ë™ì‹œ í¸ì§‘ ì œì–´

**ë‚™ê´€ì  ì ê¸ˆ:**
```typescript
interface LayerLock {
  layerId: string;
  userId: string;
  timestamp: number;
  version: number;
}

// ë²„ì „ ì¶©ëŒ ê°ì§€
const checkVersionConflict = (
  clientVersion: number, 
  serverVersion: number
): boolean => {
  return clientVersion !== serverVersion;
};
```

## ğŸ§ª 9. í…ŒìŠ¤íŠ¸ ì „ëµ

### 9.1 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

```typescript
describe('LayerStore', () => {
  test('ë ˆì´ì–´ ì¶”ê°€', () => {
    const store = useLayerStore.getState();
    const containerId = store.createContainer('canvas-1');
    const layerId = store.addLayer(containerId, LayerType.IMAGE, {});
    
    expect(store.containers[containerId].layers[layerId]).toBeDefined();
  });
  
  test('ë ˆì´ì–´ ë³€í˜•', () => {
    const transform = { x: 100, y: 200, scaleX: 1.5, scaleY: 1.5 };
    store.transformLayer(containerId, layerId, transform);
    
    expect(store.containers[containerId].layers[layerId].transform)
      .toMatchObject(transform);
  });
});
```

### 9.2 í†µí•© í…ŒìŠ¤íŠ¸

```typescript
describe('Canvas v4.0 Integration', () => {
  test('Canvas Item â†’ Layer ë³€í™˜', () => {
    const canvasItem = createMockCanvasItem('image');
    const layers = adapter.convertCanvasItemToLayers(canvasItem);
    
    expect(layers).toHaveLength(1);
    expect(layers[0].type).toBe(LayerType.IMAGE);
  });
});
```

### 9.3 ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

```typescript
describe('Rendering Performance', () => {
  test('100ê°œ ë ˆì´ì–´ ë Œë”ë§ < 16ms', async () => {
    const container = createMockContainer(100);
    
    const startTime = performance.now();
    await renderer.render(container);
    const renderTime = performance.now() - startTime;
    
    expect(renderTime).toBeLessThan(16); // 60fps ë³´ì¥
  });
});
```

## ğŸš€ 10. êµ¬í˜„ ë¡œë“œë§µ

### Phase 1: ê¸°ë³¸ ë ˆì´ì–´ ì‹œìŠ¤í…œ (2ì£¼)
- [x] íƒ€ì… ì‹œìŠ¤í…œ ì •ì˜
- [x] ë ˆì´ì–´ ìŠ¤í† ì–´ êµ¬í˜„
- [x] ê¸°ë³¸ UI ì»´í¬ë„ŒíŠ¸
- [ ] Canvas v4.0 ì–´ëŒ‘í„°

### Phase 2: WebGL ë Œë”ë§ (2ì£¼)
- [x] WebGL ì—”ì§„ ê¸°ë³¸ êµ¬ì¡°
- [ ] ì…°ì´ë” ì‹œìŠ¤í…œ ì™„ì„±
- [ ] í…ìŠ¤ì²˜ ê´€ë¦¬ ì‹œìŠ¤í…œ
- [ ] ì„±ëŠ¥ ìµœì í™”

### Phase 3: ê³ ê¸‰ í¸ì§‘ ë„êµ¬ (3ì£¼)
- [ ] ì„ íƒ ë„êµ¬ êµ¬í˜„
- [ ] ë³€í˜• ë„êµ¬ ì‹œìŠ¤í…œ
- [ ] ë§ˆìŠ¤í‚¹ ì‹œìŠ¤í…œ
- [ ] í•„í„° íš¨ê³¼

### Phase 4: í†µí•© ë° ìµœì í™” (1ì£¼)
- [ ] ê¸°ì¡´ ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸
- [ ] ì„±ëŠ¥ íŠœë‹
- [ ] ë²„ê·¸ ìˆ˜ì • ë° ì•ˆì •í™”
- [ ] ë¬¸ì„œí™” ì™„ì„±

## ğŸ“ˆ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ëª©í‘œ

| í•­ëª© | ëª©í‘œ | í˜„ì¬ ìƒíƒœ |
|------|------|-----------|
| ë Œë”ë§ ì„±ëŠ¥ | 60fps (16ms) | ì„¤ê³„ ì™„ë£Œ |
| ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ | < 500MB | ìµœì í™” í•„ìš” |
| ë¡œë”© ì‹œê°„ | < 2ì´ˆ | ì¸¡ì • í•„ìš” |
| ë™ì‹œ ë ˆì´ì–´ ìˆ˜ | 1000ê°œ | í…ŒìŠ¤íŠ¸ í•„ìš” |

## ğŸ¯ ê²°ë¡ 

Canvas v4.0 ë‹¤ì¤‘ ì´ë¯¸ì§€ í¸ì§‘ & ë ˆì´ì–´ ì‹œìŠ¤í…œì€ ë‹¤ìŒê³¼ ê°™ì€ í˜ì‹ ì„ ì œê³µí•©ë‹ˆë‹¤:

### âœ¨ í•µì‹¬ í˜ì‹ ì 

1. **ì™„ì „í•œ í˜¸í™˜ì„±**: ê¸°ì¡´ Canvas v4.0 ì‹œìŠ¤í…œê³¼ ì™„ë²½ í†µí•©
2. **ì „ë¬¸ê°€ê¸‰ ê¸°ëŠ¥**: Adobe Photoshop ìˆ˜ì¤€ì˜ ê³ ê¸‰ í¸ì§‘ ë„êµ¬
3. **ì‹¤ì‹œê°„ ì„±ëŠ¥**: WebGL ê¸°ë°˜ 60fps ì‹¤ì‹œê°„ ë Œë”ë§
4. **í™•ì¥ ê°€ëŠ¥ì„±**: í”ŒëŸ¬ê·¸ì¸ ì•„í‚¤í…ì²˜ë¡œ ë¬´í•œ í™•ì¥ ê°€ëŠ¥
5. **ì—”í„°í”„ë¼ì´ì¦ˆ ì•ˆì •ì„±**: ëŒ€ìš©ëŸ‰ ë°ì´í„° ë° ë™ì‹œ í¸ì§‘ ì™„ë²½ ì§€ì›

### ğŸš€ ê¸°ëŒ€ íš¨ê³¼

- **ì‚¬ìš©ì ê²½í—˜**: ì „ë¬¸ê°€ê¸‰ ì´ë¯¸ì§€ í¸ì§‘ ë„êµ¬ ì œê³µ
- **ìƒì‚°ì„±**: ë‹¤ì¤‘ ì´ë¯¸ì§€ ë™ì‹œ í¸ì§‘ìœ¼ë¡œ ì‘ì—… íš¨ìœ¨ ê·¹ëŒ€í™”
- **ì„±ëŠ¥**: WebGL ê°€ì†ìœ¼ë¡œ ëŠê¹€ ì—†ëŠ” ì‹¤ì‹œê°„ í¸ì§‘
- **í™•ì¥ì„±**: ëª¨ë“ˆëŸ¬ ì•„í‚¤í…ì²˜ë¡œ ì§€ì†ì ì¸ ê¸°ëŠ¥ í™•ì¥

ì´ ì•„í‚¤í…ì²˜ëŠ” Canvas v4.0ì˜ ê²€ì¦ëœ ì•ˆì •ì„±ì„ ê¸°ë°˜ìœ¼ë¡œ ì°¨ì„¸ëŒ€ ì´ë¯¸ì§€ í¸ì§‘ í”Œë«í¼ìœ¼ë¡œì˜ ì§„í™”ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.

---

**ì‘ì„±ì¼**: 2025-09-01  
**ë²„ì „**: v1.0  
**ìƒíƒœ**: ì„¤ê³„ ì™„ë£Œ - êµ¬í˜„ ì¤€ë¹„